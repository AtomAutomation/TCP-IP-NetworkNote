## 1.11 进程间通信

### 11.1 进程间通信的基本概念

进程间通信意味着两个不同进程间可以交换数据，为了完成这一点，操作系统中应该提供两个进程可以同时访问的内存空间

#### 11.1.1 对进程间通信的基本理解

无法简单实现的原因： 进程具有完全独立的内存结构，就连通过fork函数创建的子进程也不会与父进程共享内存空间。

实现： 只要有两个进程可以同时访问的内存空间，就可以通过此空间交换数据

#### 11.1.2 通过管道实现进程间通信

![](https://camo.githubusercontent.com/23dcb30d1fdfc1b0cbcc3a296af8dec7dbd59187/68747470733a2f2f73322e617831782e636f6d2f323031392f30312f32322f6b466c6b30732e706e67)

为了完成进程间通信，要创建管道，管道并非属于进程的资源而是和套接字一样属于操作系统。所以，两个进程通过操作系统提供的内存空间进行通信

```c++
#include <unistd.h>
// 成功时返回0，失败时返回-1
int pipe(int filedes[2]);
/*
filedes[0]  通过管道接收数据时使用的文件描述符， 即管道出口
filedes[1]   ...   传输数据             ...,   即管道入口   
*/
```

为了让父进程和子进程交换数据，因此需要将入口或出口中的一个文件描述符传给子进程，如何传递是通过fork函数

[pipe1.c](./pipe1.c)

```
gcc pipe1.c -o pipe1
./pipe1
```

![](https://s2.ax1x.com/2019/02/10/kUqELT.png)

可以从程序中看出，首先创建了一个管道，子进程通过 fds[1] 把数据写入管道，父进程从 fds[0] 再把数据读出来。可以从下图看出：

![](https://camo.githubusercontent.com/7aa038a10a8fb8789b75d62e1b2e6a935bfa66fd/68747470733a2f2f73322e617831782e636f6d2f323031392f30312f32322f6b46384137642e706e67)

#### 11.1.3 通过管道进行行程间双向通信

![](https://camo.githubusercontent.com/cdd0c7561c26f9519e0747d72fc7e08fbbe537ce/68747470733a2f2f73322e617831782e636f6d2f323031392f30312f32322f6b46383444652e706e67)

[pipe2.c](./pipe2.c)

![](https://s2.ax1x.com/2019/02/10/kUqhpn.png)

向管道传递数据时，先读的进程会把数据取走。所以子进程读取前会睡眠一会，等待父进程先取走数据。

当然我们可以创建两个管道，各自负责不同的数据流动即可

![](https://camo.githubusercontent.com/7f42744a48bcfa417696b0fdc7a4737e1600ff26/68747470733a2f2f73322e617831782e636f6d2f323031392f30312f32322f6b464a5730652e706e67)

使用2个管道可以避免程序流程的预测或控制

[pipe3.c](./pipe3.c)

上面通过创建两个管道实现了功能，此时，不需要额外再使用 sleep 函数。运行结果和上面一样。

### 11.2 运用进程间通信

#### 11.2.1 保存消息的回声服务器端

下面对第 10 章的 [echo_mpserv.c](../ch10/echo_mpserv.c) 进行改进，添加一个功能：
> 将回声客户端传输的字符串按序保存到文件中

实现该任务将创建一个新进程，从向客户端提供服务的进程读取字符串信息，下面是代码：

[echo_storeserv.c](./echo_storeserv.c)

![](https://s2.ax1x.com/2019/02/10/kUjFNF.png)


### 11.3 习题

> 以下答案仅代表本人个人观点，可能不是正确答案。

1. **什么是进程间通信？分别从概念和内存的角度进行说明。**

答： 两个不同进程进行数据交换。 两个不同进行通过访问同一片内存空间，通过这片内存空间的数据变化来通信

2. **进程间通信需要特殊的 IPC 机制，这是由于操作系统提供的。进程间通信时为何需要操作系统的帮助？**

答：因为进程之间不能访问对方的内存空间，我们需要管道的帮助，而管道是由操作系统提供的让两个进程都能访问的内存空间

3. **「管道」是典型的 IPC 技法。关于管道，请回答以下问题**

+ **管道是进程间交换数据的路径。如何创建此路径？由谁创建？**

答： pipe函数，操作系统

+ **为了完成进程间通信。2 个进程要同时连接管道。那2 个进程如何连接到同一管道？**

答： 管道有两个文件描述符，两个进程每个利用一个文件描述符，父进程可以通过fork函数将文件描述符复制给子进程

+ **管道允许 2 个进程间的双向通信。双向通信中需要注意哪些内容？**

答：向管道传输数据时，数据为公共数据，先读的数据会先把数据取出，要注意读取顺序。所以我们可以用2个管道来实现双向通信